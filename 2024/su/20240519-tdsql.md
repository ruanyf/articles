# 分布式数据库入门：以国产数据库 TDSQL 为例

## 一、简介

今天，我想为大家介绍分布式数据库（distributed database）。

它堪称最重要的数据库产品，几乎所有你知道的大型互联网服务，都运行在它之上。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052101.webp)

我们平时自己开发，接触的都是单机数据库（又称集中式数据库），就是数据库只运行在一台服务器上。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052001.webp)

（图片说明：左侧的单个数据库服务器，支撑着整个应用。）

**分布式数据库指的是，数据库系统分布在多台服务器。**

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052002.webp)

(图片说明：单个数据库分布在多台服务器上，共同支撑应用。)

在宏观层面，金融、电信、航空、物流、电商等国民经济的重要产业，都离不开分布式数据库。

如果没有它，我们很难想象生活会变成什么样，比如12306那样的购票网站，就没法提供服务了。

在个人层面，当你从初级开发者成长为架构师，就多多少少会遇到分布式数据库。我们设计架构，除非只用一台服务器，否则就免不了要考虑，数据在多台服务器之间如何拆分和保存。

产品做大以后，分布式数据库是避不开的。对于个人来说，这也意味着事业和能力的进步。

## 二、分布式数据库的优点

分布式数据库为什么那么重要？因为它有一些单机数据库无法比拟的优点。

**（1）更安全**。分布式数据库包含多个节点，不管是放在同一个机房，还是不同机房，都要比单机数据库安全得多。

**（2）高可用**。如果单个数据库节点故障下线，其他节点还可以照常工作，不会单点失败。

**（3）性能更好**。对于大数据、大计算量的任务，分布式数据库可以并行处理，大大缩短处理时间。

**（4）体验更好**。当数据库分布在多个机房，可以为用户分配就近的数据库节点，提供更好的响应速度。

## 三、分布式数据库的难点

虽然有上面这些优点，但是分布式数据库的使用并不普及，小公司一般不用它，这是为什么？

主要原因是，**分布式数据库有两大问题，阻碍了它的普及：成本高和复杂性。**

分布式数据库属于“异地多活”，提供了额外的冗余性，来保障数据安全，成本高自不必多言。

它的复杂性主要体现在下面几点。

**（1）一致性问题**。如何保证不同节点的数据一致？如果节点的数据不一致怎么办？

**（2）通信问题**。怎样保证节点之间的通信可靠？如果通信延迟或失败怎么办？

**（3）分区问题**。如果拆分大型数据表，数据储存在不同的节点，那么拆分策略、发生变化时的数据迁移可能会非常复杂。

**（4）优化问题**。如果来自多个节点的数据需要组合，查询就必须优化以提高性能。

## 四、CAP 定理

大家可能知道，有一条著名的 CAP 定理，说的就是分布式系统（包括分布式数据库）无法克服的局限性。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052003.webp)

分布式系统有三大目标——数据一致（Consistency）、高可用（Availability）、数据分区（Partition tolerance）。

**它们无法同时满足，最多只能同时做到两个**。在数据分区的前提下，要么为了（强）一致性，舍弃高可用；要么为了高可用，舍弃（强）一致性。

因此，任何分布式数据库都做不到完美，只能是三大目标的某种取舍和均衡。

## 五、分布式数据库的产品

分布式数据库的历史非常悠久，市场上至少有上百种产品，有开源的，也有闭源的。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052302.webp)

几乎所有的分布式数据库，既可以单机使用（即作为单机数据库），也可以多机联合，分布式使用。

开源的分布式数据库，比较有名的是 Postgres 和 MySQL（关系型数据库），以及 MongoDB 和 CockroachDB（非关系型数据库）。

商业数据库里面，最有名的就是 Oracle。它是分布式数据库事实上的标准，大企业一般都选择用它。

## 六、国产数据库 TDSQL

下面，我选择国产数据库 [TDSQL](https://cloud.tencent.com/product/tddbms) 作为示例，介绍分布式数据库的功能和用法。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052503.webp)

TDSQL 是腾讯的产品，属于国内领先的分布式数据库。腾讯的几乎所有关键业务，比如微信、QQ、腾讯音乐、腾讯游戏等等，都运行在它之上，经受了高强度、海量的实战考验。

外部很多大公司也在用它，比如小红书、拼多多、B 站、海尔、深圳地铁等等。

<u>它完全按照金融级的标准打造，属于金融级数据库，注重安全、高可用、高并发。</u>目前，腾讯云数据库 TDSQL 已服务超过50万客户。在金融行业，已服务 TOP10 银行中的7家，助力30余家金融机构完成核心系统改造。

TDSQL 是完全的国产数据库，特别强调 Oracle 的兼容，企业现有的 Oracle 数据库可以平滑迁移，它的成本要比 Oracle 低很多。如果国内企业有国产化和供应链安全的考虑，它是很好的替代品。

据了解，TDQSL 首批通过《中国信息安全测评中心的安全可靠测评结果公告（2023年第1号）》安全可靠测评，这也标志着 TDSQL 的产品能力和自主研发实力得到了国家权威机构的认可。

最后，TDSQL 是腾讯云对外公开的一个服务，任何人都可以使用。只要在网页上点击几下，就开通了，非常容易上手。

## 七、分布式数据库的功能

我们通过 TDSQL，看看分布式数据库有哪些功能。

**（1）强同步复制**。它采用主从式架构，一个集群有一个主节点（master）和若干个从节点（slave）。系统支持强同步复制，以保证数据强一致。

具体来说，数据库写入数据时，主节点会等待从节点返回操作成功消息，然后才向用户返回结果，这样保证了主节点和从节点的数据完全一致。

**（2）事务一致性**。系统为每一笔事务提供全局唯一数字序列，保证在分布式环境下的事务一致性。

**（3）自动拆分**。分布式数据库的大型数据表，往往需要进行拆分，储存在不同的节点。它支持自动水平拆分（分表），将写入数据均匀地分布到不同节点，查询也自动聚合返回。

分表对业务系统透明，业务实际所见为一张逻辑完整的表，无需感知后端的物理架构。

**（4）高度可扩展**。当数据库性能或容量不足时，它可以不停机扩展，只需在控制台点击，就可自动升级完成。分布式系统内的数据迁移、数据均衡和路由切换，都是自动的。

**（5）高度灵活性**。用户可以在线变更表结构；遇到某些类型的故障，系统可以自动恢复；所有节点，不管是主节点还是从节点，都可进行读写。

**（6）产品管控能力**。它对开发者友好，提供大量监控工具，实时监控和告警，每日推送详细的健康探查报告。

另外，腾讯云还有一款云服务 DBbrain，专门为用户的数据库提供性能、安全、管理等功能。它利用机器学习、大数据手段、专家经验引擎等手段，复制了资深 DBA 的成熟经验，将传统的人工数据库运维变成智能化，有效保障数据库服务的安全、稳定及高效运行。

它还会全方位诊断和优化 SQL，发现性能瓶颈，让 SQL、事务、业务流水全链路可观测，可视化展现死锁等异常，易于理解。

> 腾讯云数据库在 AI 方面也有强大的能力，构建了 AI 智能问答系统。它基于丰富的知识库与小模型训练，快速准确地响应用户查询，相当于一个智能客户，提供专业且个性化的解答。这不仅大幅提升了云服务的效能，还优化了客服效率，为用户带来更高效便捷的服务体验。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052303.webp)

## 八、TDSQL 的用法

下面，我来演示一下 TDSQL 的用法，很简单，在网页上开通后，你就可以使用分布式数据库了。

**第一步**，在 TDSQL 的[官网](https://cloud.tencent.com/product/tddbms)上，进入产品控制台。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052108.webp)

**第二步**，在控制台页面，选择数据库服务器所在的地域（跟你的云服务器应该是同一个地域），以及数据库引擎，然后点击“新建”按钮。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052110.webp)

目前 TDSQL 有三种引擎：MySQL、自研的 TDStore 和 PostgreSQL。<u>不管哪一种引擎，都具备一样的容灾能力和高可用，并且兼容 Oracle。</u>

**第三步**，会跳出一个配置页面，让你选择数据库配置。不同的配置，价格不一样。

其中有一项，问你要不要开通“强同步”。

![](https://cdn.beekka.com/blogimg/asset/202405/bg2024052111.webp)

强同步可以确保主节点和从节点的数据一致性。如果你的应用不要求强一致，更在意快速返回结果，这里可以选择“异步”。

**第四步**，配置完成后，会进入付款环节，然后数据库就开通了，你的分布式数据库就已经在线了。

使用时，需要先连接数据库，分成内网连接和外网连接，这里可以[参考文档](https://cloud.tencent.com/document/product/557/10238)。需要注意，如果开通外网连接，数据库就暴露在公网上，任何人都可以请求，必须注意安全风险。

连接数据库以后，就可以执行 SQL 语句了，到了这一步，就跟使用普通数据库没有任何区别。**分布式数据库的 SQL 与单机数据库，基本是一样的**。

## 九、TDSQL 的最佳实践

分布式数据有一些最佳实践，下面举出三个（以 MySQL 引擎为例）。

**（1）分布式数据库的数据导入**

分布式数据库开通以后，如何将现有数据库导入？这分成两种情况。

第一种是将现有的单机实例，导入到分布式实例。操作步骤如下（详细命令见[文档](https://cloud.tencent.com/document/product/557/7717)）。

> 1. 导出单机数据库的表结构和数据，也就是拿到两个 SQL 文件。
> 2. 打开表结构文件，设置每个表的主键（primary key），以及分片依据的 shardkey。
> 3. 将两个 SQL 文件上传到云服务器，并导入到分布式数据库。

第二种是将一个分布式实例，导入到另一个分布式实例。这种更简单，就相当于复制，操作步骤与上面一样，只是少了第二步，不需要指定主键和 shardkey，因为原来就有了。（详细命令见[文档](https://cloud.tencent.com/document/product/557/8637)）。

**（2）如何分片**

分片（sharding）是分布式数据库的核心问题之一：到底要架设多少个数据分区？数据在多个分区如何分布？

大多数情况下，一个分片就是一个节点（即一台服务器）。以下的“分片”和“节点”，这两个词是通用的。

分片数量取决于，整个数据库预估的最大并发，以及每个分片能够处理的请求数量，可以用下面的公式计算。

> 读写并发性能 = ∑（分片性能 * 分片数量）

单个分片的性能，主要与实例的 CPU / 内存数量相关。单个分片规格越高、分片数量越多，数据库系统的处理能力越强。

除了性能，分片还要考虑容量问题。一般来说，单个分片至少存储5000万行数据。

**（3）硬件的参考配置**

分布式数据库的硬件，下面给出三个推荐的配置。

> 1. 功能性测试：不要求性能，只要求测试系统，建议配置2个节点，每个节点硬件为：2GB 内存/25GB 硬盘。
> 1. 业务发展初期：数据规模较小，增长快，建议配置2个节点，每个节点硬件为：16GB 内存/200GB 硬盘。
> 1. 业务发展稳定期：根据业务实际情况配置，可以配置4个节点，每个节点硬件为：当前业务峰值*增长率/4。

## 十、总结

总的来说，当代的分布式数据库产品，将自身的大量复杂性，都隐藏了起来，为用户提供一个易用的操作接口。

一般来说，不建议自己搭建分布式数据库，即使你有专门的数据库工程师和运维工程师，成本也会非常高。使用云服务商的产品，是更经济更省事的选择。

就拿 TDSQL 来说，它有两个版本：集群版和基础版。前者是多节点的，供企业在生产环境使用；后者是单节点的，费用较低，专门供个人使用，但功能是一样的，很适合个人开发者学习或者尝试分布式数据库。

（完）

